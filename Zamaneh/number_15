-- Accrual Period Begin Date	2025
-- Accrual Period End Date	2025


SELECT 
	wrE19."Accrual Plan Name" AS c0,
	wrE19."Person User Name" AS c1,
	wrE19."Person Hire Date" AS c2,
	wrE19."Person Last Name" AS c3,
	wrE19."Person First Name" AS c4,
	wrE19."Person Cost Rate Begin Date" AS c5,
	wrE19."Person Cost Rate End Date" AS c6,
	wrE19."Person Cost Rate" AS c7,
	wrE19."Accrual Period End Date" AS c8,
	wrE19."Person Accrual Plan End Date" AS c9,
	wrE19."Hours" AS c10,
	wrE19."Transaction Type" AS c11,
	wrE19."Accrual Plan Key" AS c12,
	wrE19."Person Key" AS c13,
	wrE19."Project Key" AS c14,
	wrE19."Task Key" AS c15,
	wrE19."Accrual Period Key" AS c16,
	wrE19."Accrual Period Begin Date" AS c17,
	wrE19."Person Active" AS c18,
	wrE19."Person Org" AS c19
FROM (with accured_hours_per_plan as ( select accrued_hours, person_accrual_plan_key, source_ind, accrual_period_key, person_key, posted_timestamp as posted_date, posted_by_key as posted_by_key from ( select sum(accrued_hours) over (partition by person_accrual_plan_key, source_ind, accrual_period_key, person_key) as accrued_hours, person_accrual_plan_key, source_ind, accrual_period_key, person_key, posted_timestamp, posted_by_key, row_number() over (partition by person_accrual_plan_key, source_ind, accrual_period_key, person_key order by posted_timestamp desc) as row_num from [dbo].["aretum"."person_accrual"] where posted_timestamp is not null ) pa where row_num = 1 ) select t."Accrual Plan Key"  		            as "Accrual Plan Key", t."Person Key"  			                as "Person Key", t."Project Key"  		    	            as "Project Key", t."Task Key"  				                as "Task Key", t."Accrual Period Key"   	            as "Accrual Period Key", t."Fiscal Month Key"     	            as "Fiscal Month Key", t."Customer Key"  			              as "Customer Key", t."Accrual Plan Name"   		          as "Accrual Plan Name", t."Accrual Plan Description"   	      as "Accrual Plan Description", t."Accrual Plan Period Type"   	      as "Accrual Plan Period Type", t."Accrual Plan Begin Date"   	      as "Accrual Plan Begin Date", t."Accrual Plan Carryover Type"       as "Accrual Plan Carryover Type", t."Accrual Plan Active"   		        as "Accrual Plan Active", t."Accrual Plan Rate Method"   	      as "Accrual Plan Rate Method", t."Person Last Name"   			          as "Person Last Name", t."Person Org"   				              as "Person Org", t."Person User Name"    		          as "Person User Name", t."Person First Name"   		          as "Person First Name", t."Person Active"   			            as "Person Active", case when exists(select null from [dbo].["aretum"."member"] where person_key = '3896'  and role_key in (1,10,11,21)) then    t."Person Cost Rate" else        null end  	  						                  as "Person Cost Rate", case when exists(select null from [dbo].["aretum"."member"] where person_key = '3896'  and role_key in (1,10,11,21)) then    t."Person Cost Rate Begin Date" else        null end  	  						                  as "Person Cost Rate Begin Date", case when exists(select null from [dbo].["aretum"."member"] where person_key = '3896'  and role_key in (1,10,11,21)) then    t."Person Cost Rate End Date" else        null end  	  						                  as "Person Cost Rate End Date", case when exists(select null from [dbo].["aretum"."member"] where person_key = '3896'  and role_key in (1,10,11,21)) then    cc.ISO_Currency_Code else        null end  as "Cost Rate Currency", t."Person Business Week Hours"        as "Person Business Week Hours", t."Person Hire Date"   			          as "Person Hire Date", t."Transaction Type"   			        as "Transaction Type", t."Hours"   					                as "Hours", t."Accrual Plan Project Code"         as "Accrual Plan Project Code", t."Accrual Plan Project Name"         as "Accrual Plan Project Name", t."Accrual Plan Task Name"   	        as "Accrual Plan Task Name", t."Accrual Plan Project Type"         as "Accrual Plan Project Type", t."Person Accrual Plan Begin Date"   	as "Person Accrual Plan Begin Date", t."Person Accrual Plan End Date"		  as "Person Accrual Plan End Date", t."Leave Of Absence Begin Date"   		as "Leave Of Absence Begin Date", t."Leave Of Absence End Date"   		  as "Leave Of Absence End Date", t."Accrual Period Begin Date"   		  as "Accrual Period Begin Date", t."Accrual Period End Date"   			  as "Accrual Period End Date", t."Begin Fiscal Period"  				      as "Begin Fiscal Period", t."Ending Fiscal Period"  				    as "Ending Fiscal Period", t."Post Date"     					as "Post Date", t."Posted By First Name" 			as "Posted By First Name", t."Posted By Last Name" 			as "Posted By Last Name", t."Posted By Username" 				as "Posted By Username", t."Work Date" 						as "Work Date"  from ( select ap.accrual_plan_key		as "Accrual Plan Key", per.person_key			as "Person Key", pap.project_key			as "Project Key", pap.task_key			as "Task Key", a_per.accrual_period_key 	as "Accrual Period Key", fm_b.fiscal_month_key   as "Fiscal Month Key", porg.customer_key		as "Customer Key", ap.accrual_plan 		as "Accrual Plan Name", ap.description 			as "Accrual Plan Description", ap.period_type 			as "Accrual Plan Period Type", ap.begin_date 			as "Accrual Plan Begin Date", ap.carryover_ind 		as "Accrual Plan Carryover Type", ap.active 				as "Accrual Plan Active", ap.rate_method 			as "Accrual Plan Rate Method", per.last_name 			as "Person Last Name", porg.customer_name 		as "Person Org", per.username  			as "Person User Name", per.first_name 			as "Person First Name", per.active 				as "Person Active",  (select max(tt.cost_rate) from (select max(pr.cost_rate) over(partition by pr.person_key  order by pr.begin_date desc ) as cost_rate ,pr.person_key from [dbo].["aretum"."person_rate"] 		pr		where pr.person_key = per.person_key and (pr.begin_date between a_per.begin_date and a_per.end_date or pr.end_date between a_per.begin_date and a_per.end_date or (pr.begin_date < a_per.begin_date and pr.end_date > a_per.end_date) )) tt group by tt.person_key) as "Person Cost Rate",  (select max(pr.begin_date) as begin_date from [dbo].["aretum"."person_rate'] 		pr		where pr.person_key = per.person_key and (pr.begin_date between a_per.begin_date and a_per.end_date or pr.end_date between a_per.begin_date and a_per.end_date or (pr.begin_date < a_per.begin_date and pr.end_date > a_per.end_date) ) group by pr.person_key  )as "Person Cost Rate Begin Date",   (select max(pr.end_date) as end_date from [dbo].["aretum"."person_rate"] 		pr		where pr.person_key = per.person_key and (pr.begin_date between a_per.begin_date and a_per.end_date or pr.end_date between a_per.begin_date and a_per.end_date or (pr.begin_date < a_per.begin_date and pr.end_date > a_per.end_date) ) group by pr.person_key  ) as "Person Cost Rate End Date",  bw.hours 				as "Person Business Week Hours", per.hire_date 			as "Person Hire Date", case ahpp.source_ind when 'I'  then 'Initial' when 'A'  then 'Adjustment' when 'P'  then 'Posted' when 'U'  then 'Unposted' when 'C'  then 'Carry-Over' when 'T'  then 'Transfer' else         null end 					as "Transaction Type", round(ahpp.accrued_hours,3) 		as "Hours", prj.project_code 		as "Accrual Plan Project Code", prj.title 				as "Accrual Plan Project Name", t.task_name 			as "Accrual Plan Task Name", pt.project_type 		as "Accrual Plan Project Type", pap.begin_date 			as "Person Accrual Plan Begin Date", pap.end_date 			as "Person Accrual Plan End Date", pap.loa_start_date 		as "Leave Of Absence Begin Date", pap.loa_end_date 		as "Leave Of Absence End Date", a_per.begin_date 			as "Accrual Period Begin Date", a_per.end_date 			as "Accrual Period End Date", case when fm_b.period_number < 10 then concat(concat(concat(fy_b.name,'-'),'0'),cast(fm_b.period_number as varchar(4))) else concat(concat(fy_b.name,'-'),cast(fm_b.period_number as varchar(4))) end						as "Begin Fiscal Period",  case when fm_e.period_number < 10 then concat(concat(concat(fy_e.name,'-'),'0'),cast(fm_e.period_number as varchar(4))) else concat(concat(fy_e.name,'-'),cast(fm_e.period_number as varchar(4))) end						as "Ending Fiscal Period",  ahpp.posted_date     	as "Post Date", posted_by.first_name 	as "Posted By First Name", posted_by.last_name 	as "Posted By Last Name", posted_by.username 		as "Posted By Username", cast(null as date)		as "Work Date", per.currency_code_key as "Currency Code Key"  from accrual_plan ap inner join accrual_period      		a_per 	on a_per.accrual_plan_key = ap.accrual_plan_key inner join person_accrual_plan 		pap 	on pap.accrual_plan_key = ap.accrual_plan_key inner join accured_hours_per_plan 	ahpp 	on ahpp.person_accrual_plan_key = pap.person_accrual_plan_key and ahpp.accrual_period_key = a_per.accrual_period_key and ahpp.person_key = pap.person_key left outer join person posted_by			on posted_by.person_key = ahpp.posted_by_key left outer join task t 						on pap.task_key = t.task_key left outer join project prj 				on pap.project_key = prj.project_key left outer join person per 					on pap.person_key = per.person_key left outer join customer porg    			on porg.customer_key = per.customer_key left outer join business_week       bw      on bw.business_week_key = per.business_week_key left outer join project_type 		pt 		on pt.project_type_key = prj.project_type_key left outer join fiscal_month    	fm_b    on pap.begin_date between fm_b.begin_date and fm_b.end_date left outer join fiscal_year     	fy_b    on fy_b.fiscal_year_key = fm_b.fiscal_year_key left outer join fiscal_month    	fm_e    on pap.end_date between fm_e.begin_date and fm_e.end_date left outer join fiscal_year     	fy_e    on fy_e.fiscal_year_key = fm_e.fiscal_year_key union all select  ap.accrual_plan_key		as "Accrual Plan Key", per.person_key			as "Person Key", pap.project_key			as "Project Key", pap.task_key			as "Task Key", a_per.accrual_period_key 	as "Accrual Period Key", fm_b.fiscal_month_key   as "Fiscal Month Key", porg.customer_key		as "Customer Key", ap.accrual_plan 		as "Accrual Plan Name", ap.description 			as "Accrual Plan Description", ap.period_type 			as "Accrual Plan Period Type", ap.begin_date 			as "Accrual Plan Begin Date", ap.carryover_ind 		as "Accrual Plan Carryover Type", ap.active 				as "Accrual Plan Active", ap.rate_method 			as "Accrual Plan Rate Method", per.last_name 			as "Person Last Name", porg.customer_name 		as "Person Org", per.username  			as "Person User Name", per.first_name 			as "Person First Name", per.active 				as "Person Active",  (select max(tt.cost_rate) from (select max(pr.cost_rate) over(partition by pr.person_key  order by pr.begin_date desc ) as cost_rate ,pr.person_key from person_rate 		pr		where pr.person_key = per.person_key and (pr.begin_date between a_per.begin_date and a_per.end_date or pr.end_date between a_per.begin_date and a_per.end_date or (pr.begin_date < a_per.begin_date and pr.end_date > a_per.end_date) )) tt group by tt.person_key) as "Person Cost Rate",  (select max(pr.begin_date) as begin_date from person_rate 		pr		where pr.person_key = per.person_key and (pr.begin_date between a_per.begin_date and a_per.end_date or pr.end_date between a_per.begin_date and a_per.end_date or (pr.begin_date < a_per.begin_date and pr.end_date > a_per.end_date) ) group by pr.person_key  )as "Person Cost Rate Begin Date",   (select max(pr.end_date) as end_date from person_rate 		pr		where pr.person_key = per.person_key and (pr.begin_date between a_per.begin_date and a_per.end_date or pr.end_date between a_per.begin_date and a_per.end_date or (pr.begin_date < a_per.begin_date and pr.end_date > a_per.end_date) ) group by pr.person_key  ) as "Person Cost Rate End Date",  bw.hours 				as "Person Business Week Hours", per.hire_date 			as "Person Hire Date", 'Used' 					as "Transaction Type", - ptd.quantity 			as "Hours", prj.project_code 		as "Accrual Plan Project Code", prj.title 				as "Accrual Plan Project Name", t.task_name 			as "Accrual Plan Task Name", prt.project_type 		as "Accrual Plan Project Type", pap.begin_date 			as "Person Accrual Plan Begin Date", pap.end_date 			as "Person Accrual Plan End Date", pap.loa_start_date 		as "Leave Of Absence Begin Date", pap.loa_end_date 		as "Leave Of Absence End Date", a_per.begin_date 			as "Accrual Period Begin Date", a_per.end_date 			as "Accrual Period End Date", case when fm_b.period_number < 10 then concat(concat(concat(fy_b.name,'-'),'0'),cast(fm_b.period_number as varchar(4))) else concat(concat(fy_b.name,'-'),cast(fm_b.period_number as varchar(4))) end						as "Begin Fiscal Period",  case when fm_e.period_number < 10 then concat(concat(concat(fy_e.name,'-'),'0'),cast(fm_e.period_number as varchar(4))) else concat(concat(fy_e.name,'-'),cast(fm_e.period_number as varchar(4))) end						as "Ending Fiscal Period",  ph.post_timestamp     	as "Post Date", posted_by.first_name 	as "Posted By First Name", posted_by.last_name 	as "Posted By Last Name", posted_by.username 		as "Posted By Username", ptd.work_date			as "Work Date", per.currency_code_key as "Currency Code Key"  from person_time_data 			ptd join person_time 				pt 		on pt.person_time_key = ptd.person_time_key inner join person_accrual_plan 	pap 	on pap.project_key = ptd.project_key and pap.person_key=pt.person_key and ptd.work_date between pap.begin_date and pap.end_date and (pap.task_key is null or ptd.task_key = pap.task_key) inner join accrual_plan 		ap 		on pap.accrual_plan_key = ap.accrual_plan_key inner join accrual_period      a_per 	on a_per.accrual_plan_key = ap.accrual_plan_key and ptd.work_date between a_per.begin_date and a_per.end_date inner join person 				per 	on pap.person_key = per.person_key left outer join customer 		porg  	on porg.customer_key = per.customer_key left outer join business_week   bw      on bw.business_week_key = per.business_week_key inner join project 				prj 	on pap.project_key = prj.project_key left outer join project_type 	prt 	on prt.project_type_key = prj.project_type_key left outer join task 			t 		on pap.task_key = t.task_key left outer join fiscal_month    fm_b    on pap.begin_date between fm_b.begin_date and fm_b.end_date left outer join fiscal_year     fy_b    on fy_b.fiscal_year_key = fm_b.fiscal_year_key left outer join fiscal_month    fm_e    on pap.end_date between fm_e.begin_date and fm_e.end_date left outer join fiscal_year     fy_e    on fy_e.fiscal_year_key = fm_e.fiscal_year_key left outer join post_history    ph 		on ph.post_history_key = ptd.post_history_key left outer join person 		posted_by	on posted_by.person_key = ph.posted_by_key )t inner join currency_code cc on t."Currency Code Key" = cc.Currency_Code_Key where (exists (select 'x' from member where person_key = '3896' and role_key in (1,21)))  or ( exists ( select 'x' from approval_chain c join approval_group_submitter s on s.chain_key = c.chain_key where t."Person Key" = s.person_key and c.person_key = '3896' and s.approval_type in (1,2)) or exists ( select 'x' from approval_chain c join alternate a on a.person_key = c.person_key join approval_group_submitter s on s.chain_key = c.chain_key where a.alternate_key = '3896' and t."Person Key" = s.person_key and a.role_key = 2 and s.approval_type in (1,2)) or exists ( select 'x' from org_access_person oap where oap.global_access = 'Y' and oap.person_key = '3896' and oap.access_type = 0 and oap.role_key in (2,7,11)) or t."Customer Key" in ( select h.customer_key from org_access_hierarchy h join org_access_person oap on oap.org_access_person_key = h.org_access_person_key where oap.person_key = '3896' and oap.access_type = 0 and oap.role_key in (2,7,11)) or exists ( select 'x' from org_access_person oap join alternate a on a.person_key = oap.person_key and a.role_key = oap.role_key where oap.global_access = 'Y' and a.alternate_key = '3896' and oap.access_type = 0 and oap.role_key in (2,7,11)) or t."Customer Key" in ( select h.customer_key from org_access_hierarchy h join org_access_person oap on oap.org_access_person_key = h.org_access_person_key join alternate a on a.person_key = oap.person_key and a.role_key = oap.role_key where a.alternate_key = '3896' and oap.access_type = 0 and oap.role_key in (2,7,11)) ) 
) wrE19
WHERE 
	((wrE19."Accrual Period Begin Date" <= '2025-01-01 23:59:59.997' OR wrE19."Accrual Period End Date" <= '2025-06-27 23:59:59.997') AND wrE19."Person Active" IN ('Y'))
ORDER BY 
	wrE19."Accrual Plan Name" ASC, wrE19."Person User Name" ASC, CONCAT(wrE19."Person Last Name", ',', ' ', wrE19."Person First Name") ASC, wrE19."Person Cost Rate End Date" DESC, wrE19."Accrual Period End Date" DESC